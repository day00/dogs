<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ESA Puppy Scoring Tool</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            background-color: #f5f5f5;
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .save-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #4CAF50;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        .save-indicator.show {
            opacity: 1;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
        }
        
        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .instructions {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .instructions h2 {
            margin-top: 0;
            font-size: 20px;
        }
        
        .instructions p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .puppy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 100px;
        }
        
        @media (max-width: 768px) {
            .puppy-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        
        .puppy-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .puppy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .puppy-name-section {
            flex: 1;
            min-width: 200px;
        }
        
        .puppy-name {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin: 0;
            display: inline-block;
        }
        
        .puppy-breed {
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 3px;
        }
        
        .esa-score-badge {
            background: #1976d2;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .esa-score-badge.exceptional {
            background: #4CAF50;
        }
        
        .esa-score-badge.strong {
            background: #2196F3;
        }
        
        .esa-score-badge.moderate {
            background: #FF9800;
        }
        
        .puppy-price {
            font-size: 18px;
            color: #27ae60;
            font-weight: bold;
        }
        
        .special-badges {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .badge {
            font-size: 20px;
        }
        
        .puppy-details {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        
        .detail-label {
            font-weight: bold;
            color: #555;
        }
        
        .esa-qualities {
            margin: 10px 0;
            padding: 10px;
            background-color: #e8f5e9;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        
        .esa-qualities h4 {
            margin: 0 0 8px 0;
            color: #2e7d32;
            font-size: 16px;
        }
        
        .esa-qualities ul {
            margin: 0;
            padding-left: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .esa-qualities li {
            margin: 3px 0;
        }
        
        .key-evidence {
            margin: 10px 0;
            padding: 10px;
            background-color: #fff3cd;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }
        
        .key-evidence h4 {
            margin: 0 0 5px 0;
            color: #856404;
            font-size: 16px;
        }
        
        .key-evidence p {
            margin: 0;
            font-size: 14px;
            line-height: 1.4;
            font-style: italic;
        }
        
        .analysis-quality {
            margin: 10px 0;
            padding: 8px;
            background-color: #f0f0f0;
            border-radius: 6px;
            font-size: 13px;
            color: #666;
        }
        
        .scoring-section {
            margin-top: 15px;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 8px;
        }
        
        .scoring-section h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        
        .score-slider {
            width: 100%;
            height: 40px;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }
        
        .score-slider::-webkit-slider-track {
            background: #ddd;
            height: 8px;
            border-radius: 4px;
        }
        
        .score-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 30px;
            height: 30px;
            background: #1976d2;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .score-slider::-moz-range-track {
            background: #ddd;
            height: 8px;
            border-radius: 4px;
        }
        
        .score-slider::-moz-range-thumb {
            width: 30px;
            height: 30px;
            background: #1976d2;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        .score-display {
            font-size: 36px;
            font-weight: bold;
            color: #1976d2;
            text-align: center;
            margin: 10px 0;
        }
        
        .notes-section {
            margin-top: 15px;
        }
        
        .notes-section h4 {
            margin: 0 0 8px 0;
            font-size: 16px;
        }
        
        .notes-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            font-size: 14px;
        }
        
        .link-button {
            display: inline-block;
            margin-top: 10px;
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 14px;
            text-align: center;
        }
        
        .export-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .export-button {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: bold;
            color: white;
            background-color: #27ae60;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        .export-button:active {
            background-color: #229954;
            transform: scale(0.98);
        }
        
        .reset-button {
            background-color: #e74c3c;
        }
        
        .reset-button:active {
            background-color: #c0392b;
        }
        
        .sort-section {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .sort-button {
            padding: 8px 16px;
            background-color: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            touch-action: manipulation;
        }
        
        .sort-button.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .puppy-name {
                font-size: 18px;
            }
            
            .puppy-price {
                font-size: 16px;
            }
            
            .export-button {
                font-size: 12px;
                padding: 10px 15px;
            }
        }
        
        @media print {
            .export-section, .sort-section, .scoring-section, .notes-section, .save-indicator {
                display: none !important;
            }
            .puppy-card {
                break-inside: avoid;
                margin-bottom: 20px;
            }
            body {
                background: white;
            }
        }
        
        .summary-only {
            display: none;
        }
        
        @media print {
            .summary-only {
                display: block !important;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: white;
                padding: 20px;
                z-index: 9999;
            }
            .puppy-grid, h1, .instructions {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="save-indicator" id="saveIndicator">✓ Saved</div>
    
    <h1>🐕 ESA Puppy Scoring Tool</h1>
    
    <div id="loadingIndicator" class="loading">
        Loading puppy data...
    </div>
    
    <div id="errorMessage" class="error" style="display: none;">
        <h3>Error Loading Data</h3>
        <p>Could not load puppy data from JSON file. Please check:</p>
        <ul style="text-align: left; display: inline-block;">
            <li>The JSON file exists and is accessible</li>
            <li>The file format is valid JSON</li>
            <li>Your browser allows loading local files (try using a web server)</li>
        </ul>
        <button onclick="retryLoad()" style="margin-top: 10px; padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer;">Retry</button>
    </div>
    
    <div id="mainContent" style="display: none;">
        <div class="instructions">
            <h2>Find Your Perfect Emotional Support Dog</h2>
            <p>Dogs are pre-scored by ESA qualities. Rate each based on your personal connection!</p>
            <p>⭐⭐⭐ = Exceptional ESA (10-12) | ⭐⭐ = Strong ESA (7-9) | ⭐ = Potential ESA (4-6)</p>
        </div>
        
        <div class="sort-section">
            <button class="sort-button active" onclick="sortPuppies('esa')">By ESA Score</button>
            <button class="sort-button" onclick="sortPuppies('score')">By Your Score</button>
            <button class="sort-button" onclick="sortPuppies('price')">By Price</button>
            <button class="sort-button" onclick="sortPuppies('size')">By Size</button>
        </div>
        
        <div class="puppy-grid" id="puppyGrid">
            <!-- Puppy cards will be inserted here -->
        </div>
        
        <div class="export-section">
            <button class="export-button" onclick="exportToPDF()">📄 Export PDF</button>
            <button class="export-button" onclick="exportToCSV()">📊 Export Excel</button>
            <button class="export-button reset-button" onclick="resetScores()">🔄 Reset All</button>
        </div>
    </div>
    
    <div class="summary-only" id="printSummary"></div>

    <script>
        let puppies = [];
        
        // Helper function to translate C2C to human readable
        function getESAQualities(c2cPattern) {
            const qualities = [];
            if (c2cPattern.includes('[⟡]')) qualities.push('Active therapy - brightens your day');
            if (c2cPattern.includes('[※]')) qualities.push('Deep loyalty & devotion');
            if (c2cPattern.includes('[⟳]')) qualities.push('Daily consistency & reliability');
            if (c2cPattern.includes('[→]')) qualities.push('Shadow dog - stays by your side');
            if (c2cPattern.includes('[∰]')) qualities.push('Physical comfort & cuddles');
            if (c2cPattern.includes('[⊙]')) qualities.push('Calm, peaceful presence');
            if (c2cPattern.includes('[◊]')) qualities.push('Note: Some behaviors are conditional');
            if (c2cPattern.includes('[⚡]')) qualities.push('Warning: High energy levels');
            return qualities;
        }
        
        // Get ESA badge info
        function getESABadge(score) {
            if (score >= 10) return { class: 'exceptional', stars: '⭐⭐⭐' };
            if (score >= 7) return { class: 'strong', stars: '⭐⭐' };
            if (score >= 4) return { class: 'moderate', stars: '⭐' };
            return null;
        }
        
        // Get special badges based on notes or other indicators
        function getSpecialBadges(puppy) {
            const badges = [];
            if (puppy.notes && puppy.notes.includes('BUDGET FRIENDLY')) badges.push('🔥');
            if (puppy.notes && puppy.notes.includes('IDEAL SIZE')) badges.push('💎');
            if (puppy.esaScore >= 12) badges.push('🏆');
            if (puppy.keyTraits && puppy.keyTraits.toLowerCase().includes('trained')) badges.push('🎓');
            return badges;
        }
        
        // Extract weight range for sorting
        function getWeightValue(weightString) {
            const match = weightString.match(/(\d+)-(\d+)/);
            if (match) {
                return parseInt(match[1]); // Use minimum weight for sorting
            }
            return 0;
        }
        
        // Load puppy data from JSON
        async function loadPuppyData() {
            try {
                // Try multiple possible JSON file locations
                const possiblePaths = [
                    './puppies.json',
                    './data/puppies.json',
                    '../puppies.json',
                    'puppies.json'
                ];
                
                let response = null;
                let lastError = null;
                
                for (const path of possiblePaths) {
                    try {
                        response = await fetch(path);
                        if (response.ok) break;
                    } catch (error) {
                        lastError = error;
                        continue;
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error(`Failed to load JSON file. Last error: ${lastError?.message || 'File not found'}`);
                }
                
                const data = await response.json();
                
                // Initialize puppy data with defaults
                puppies = data.map((puppy, index) => ({
                    ...puppy,
                    id: index,
                    score: 5, // Default user score
                    userNotes: "" // User's personal notes
                }));
                
                // Load saved user data
                loadSavedData();
                
                // Show main content and hide loading
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
                // Initial render
                puppies.sort((a, b) => b.esaScore - a.esaScore);
                renderPuppies();
                
            } catch (error) {
                console.error('Error loading puppy data:', error);
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
            }
        }
        
        // Retry loading data
        function retryLoad() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('loadingIndicator').style.display = 'block';
            loadPuppyData();
        }
        
        // Load saved user scores and notes
        function loadSavedData() {
            const saved = localStorage.getItem('puppyScores');
            if (saved) {
                try {
                    const savedData = JSON.parse(saved);
                    puppies.forEach(puppy => {
                        const savedPuppy = savedData.find(p => p.name === puppy.name);
                        if (savedPuppy) {
                            puppy.score = savedPuppy.score || 5;
                            puppy.userNotes = savedPuppy.userNotes || "";
                        }
                    });
                } catch (error) {
                    console.error('Error loading saved data:', error);
                }
            }
        }
        
        // Save user data
        function saveData() {
            const dataToSave = puppies.map(p => ({
                name: p.name,
                score: p.score,
                userNotes: p.userNotes
            }));
            localStorage.setItem('puppyScores', JSON.stringify(dataToSave));
            
            // Show save indicator
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 1500);
        }
        
        // Render puppy cards
        function renderPuppies() {
            const grid = document.getElementById('puppyGrid');
            grid.innerHTML = '';
            
            puppies.forEach(puppy => {
                const card = document.createElement('div');
                card.className = 'puppy-card';
                
                const badge = getESABadge(puppy.esaScore);
                const specialBadges = getSpecialBadges(puppy);
                const esaQualities = getESAQualities(puppy.c2cPattern || '');
                
                card.innerHTML = `
                    <div class="puppy-header">
                        <div class="puppy-name-section">
                            <h3 class="puppy-name">${puppy.name}</h3>
                            <span class="puppy-breed">(${puppy.breed})</span>
                            ${specialBadges.length > 0 ? `<div class="special-badges">${specialBadges.map(b => `<span class="badge">${b}</span>`).join('')}</div>` : ''}
                        </div>
                        ${badge ? `<div class="esa-score-badge ${badge.class}">ESA: ${puppy.esaScore} ${badge.stars}</div>` : ''}
                        <div class="puppy-price">$${puppy.price}</div>
                    </div>
                    
                    <div class="puppy-details">
                        <div class="detail-row">
                            <span class="detail-label">Weight:</span>
                            <span>${puppy.weight}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Location:</span>
                            <span>${puppy.location}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Website:</span>
                            <span>${puppy.website || 'Crockett Doodles'}</span>
                        </div>
                    </div>
                    
                    ${esaQualities.length > 0 ? `
                    <div class="esa-qualities">
                        <h4>ESA Qualities:</h4>
                        <ul>
                            ${esaQualities.map(q => `<li>${q}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    ${puppy.keyTraits ? `
                    <div class="key-evidence">
                        <h4>Key Traits:</h4>
                        <p>${puppy.keyTraits}</p>
                    </div>
                    ` : ''}
                    
                    ${puppy.notes ? `
                    <div class="analysis-quality">
                        <strong>Special Notes:</strong> ${puppy.notes}
                    </div>
                    ` : ''}
                    
                    <a href="${puppy.link}" target="_blank" class="link-button">View Full Profile</a>
                    
                    <div class="scoring-section">
                        <h4>Your Score:</h4>
                        <input type="range" class="score-slider" min="0" max="10" value="${puppy.score}" 
                               oninput="updateScore(${puppy.id}, this.value)">
                        <div class="score-display" id="score-${puppy.id}">${puppy.score}</div>
                    </div>
                    
                    <div class="notes-section">
                        <h4>Your Notes:</h4>
                        <textarea class="notes-input" placeholder="What behaviors do you see? Did they show calm behavior? Any concerns?"
                                  onblur="updateNotes(${puppy.id}, this.value)">${puppy.userNotes}</textarea>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        // Update score
        function updateScore(id, score) {
            puppies[id].score = parseInt(score);
            document.getElementById(`score-${id}`).textContent = score;
            saveData();
        }
        
        // Update notes
        function updateNotes(id, notes) {
            puppies[id].userNotes = notes;
            saveData();
        }
        
        // Reset all scores
        function resetScores() {
            if (confirm('Are you sure you want to reset all scores and notes?')) {
                puppies.forEach(puppy => {
                    puppy.score = 5;
                    puppy.userNotes = "";
                });
                saveData();
                renderPuppies();
            }
        }
        
        // Sort puppies
        function sortPuppies(method) {
            document.querySelectorAll('.sort-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            switch(method) {
                case 'esa':
                    puppies.sort((a, b) => b.esaScore - a.esaScore);
                    break;
                case 'score':
                    puppies.sort((a, b) => b.score - a.score);
                    break;
                case 'price':
                    puppies.sort((a, b) => a.price - b.price);
                    break;
                case 'size':
                    puppies.sort((a, b) => getWeightValue(a.weight) - getWeightValue(b.weight));
                    break;
            }
            renderPuppies();
        }
        
        // Export to PDF (print)
        function exportToPDF() {
            const summary = document.getElementById('printSummary');
            const sortedPuppies = [...puppies].sort((a, b) => b.score - a.score);
            
            let html = `
                <h1>My ESA Puppy Rankings</h1>
                <p style="text-align: center; color: #666;">Generated on ${new Date().toLocaleDateString()}</p>
                <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                    <thead>
                        <tr style="background-color: #f4f4f4;">
                            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Rank</th>
                            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Puppy</th>
                            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">ESA/Your Score</th>
                            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Details</th>
                            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Notes</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sortedPuppies.forEach((puppy, index) => {
                html += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd;">#${index + 1}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">
                            <strong>${puppy.name}</strong><br>
                            <small>${puppy.breed}</small>
                        </td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                            ESA: ${puppy.esaScore}<br>
                            You: ${puppy.score}/10
                        </td>
                        <td style="padding: 10px; border: 1px solid #ddd;">
                            <strong>Price:</strong> $${puppy.price}<br>
                            <strong>Weight:</strong> ${puppy.weight}<br>
                            <strong>Location:</strong> ${puppy.location}<br>
                            ${puppy.keyTraits ? `<strong>Key Traits:</strong> ${puppy.keyTraits}` : ''}
                        </td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${puppy.userNotes || 'No notes'}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                <div style="margin-top: 30px;">
                    <h3>Top 3 Choices:</h3>
                    <ol>
            `;
            
            sortedPuppies.slice(0, 3).forEach(puppy => {
                html += `<li><strong>${puppy.name}</strong> (${puppy.breed}) - Your Score: ${puppy.score}/10, ESA: ${puppy.esaScore}<br>
                         Link: ${puppy.link}</li>`;
            });
            
            html += `
                    </ol>
                </div>
            `;
            
            summary.innerHTML = html;
            window.print();
            setTimeout(() => { summary.innerHTML = ''; }, 100);
        }
        
        // Export to CSV
        function exportToCSV() {
            const sortedPuppies = [...puppies].sort((a, b) => b.score - a.score);
            
            let csv = 'Rank,Name,Breed,Your Score,ESA Score,Price,Weight,Location,Key Traits,Your Notes,Link\n';
            
            sortedPuppies.forEach((puppy, index) => {
                const keyTraits = puppy.keyTraits ? '"' + puppy.keyTraits.replace(/"/g, '""') + '"' : '';
                const userNotes = puppy.userNotes ? '"' + puppy.userNotes.replace(/"/g, '""') + '"' : '';
                
                csv += `${index + 1},"${puppy.name}","${puppy.breed}",${puppy.score},${puppy.esaScore},${puppy.price},"${puppy.weight}","${puppy.location}",${keyTraits},${userNotes},"${puppy.link}"\n`;
            });
            
            // Create download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'esa_puppy_rankings_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // Initialize the application
        loadPuppyData();
    </script>
</body>
</html>
